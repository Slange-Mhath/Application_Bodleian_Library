<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Media migration Tobar and Dulchais</title>
    <meta name="description" content="Application Bodleian Library" />
    <meta name="author" content="Sebastian Lange" />
    <script src="https://kit.fontawesome.com/df0850e7ca.js" crossorigin="anonymous"></script>
    <script type="text/javascript" src="src/plugins/substep/substep.js"></script>
    <script type="text/javascript" src="src/impress.js"></script>
    <link rel="stylesheet" href="highlight/styles/agate.css">
    <script src="highlight/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <link href="vendor/skeleton/skeleton-2.0.4.css" rel="stylesheet" />
    <link href="/css/impress-common.css" rel="stylesheet" />
    <link href="css/presentation.css" rel="stylesheet" />
    <link href="css/skeleton.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Cabin:ital,wght@0,400;0,500;0,600;1,400;1,500&family=Lato:ital,wght@0,300;0,400;0,700;0,900;1,300;1,400;1,700&display=swap" rel="stylesheet">

</head>
<body class="impress-not-supported">
<div class="fallback-message">
    <p>Your browser <b>doesn't support the features required</b> by impress.js, so you are presented with a simplified version of this presentation.</p>
    <p>For the best experience please use the latest <b>Chrome</b>, <b>Safari</b> or <b>Firefox</b> browser.</p>
</div>

<!-- Some images that are fixed to background in the css -->

<img id="applepie-image" class="bg" src="">
<img id="old-guitar-image" class="bg" src="images/old_guitar.png">
<img id="track_tape-image" class="bg" src="images/track_tape_structure.png">
<img id="tolkien-migration-image" class="bg" src="images/tolkien_migration.png">




<div id="impress" data-transition-duration="1000">

    <div class="step" data-scale="2" data-x="-500" data-y="-500">
        <h4><strong>10/26/2020</strong> | Bodleian Digital Library Systems & Services (BDLSS)</h4>
        <h4><strong>Application as Software Engineer (Digital Research)</strong></h4>
        <div class="heading">
        <h1>Tobar and Dulchais</h1>
        <h2>Migration of media files into ArchivesSpace</h2>
        </div>
        <h4 class="down-100">
            <strong>Slides:</strong>
            <a href="#" title="View the presentation online">
                Link to the presentation
            </a>
        </h4>
        <h4>
            <strong>Code:</strong>
            <a href="https://github.com/Slange-Mhath/Application_Bodleian_Library/blob/main/Migration%20Script/mp4_migration.py" title="View my code on GitHub">
                Link to the code
            </a>
        </h4>

        <h5>
            <strong><a class="mysite" href="www.sebastian-lange.eu">Sebastian Lange</a></strong> |
            <a class="twitter" href="https://twitter.com/BastiiLange" title="Sebastian Lange on Twitter"><i class="fab fa-twitter"></i>@BastiiLange</a> |
            <a class="orcid" href="https://orcid.org/0000-0003-2590-6266" title="Sebastian Lange on ORCID"><i class="fab fa-orcid"></i>0000-0003-2590-6266</a> |
            <a class="github" href="https://github.com/Slange-Mhath" title="Sebastian Lange on GitHub"><i class="fab fa-github"></i>Slange-Mhath</a>
        </h5>
    </div>

    <div id="contents" class="step" data-rel-x="1500" data-rel-y="1500" data-scale="1">
        <h1>Background:</h1>
        <p>Tobar and Dulchais is the biggest and most important data repository of Scottish/Gaelic music worldwide</p>
        <ul>
            <li class="substep" style="margin-top: 10%;">Tobar and Dulchais Data:
                <ul>
                <li>Digitised tapes with ~50.000 tracks</li>
                <li>Stored in an ad-hoc Postgres-DB</li>
                <li>~ 100 Images </li>
                </ul>
            </li>
        </ul>
    </div>

    <!-- The challenge(3) -->
    <div id="challenge" class="step" data-x="2000" data-y="2000"
         data-goto-key-list="ArrowUp ArrowDown ArrowLeft ArrowRight"
         data-goto-next-list="contents plan-goals contents starting">
        <h1>The challenge:</h1>

        <ul>
            <li>Migrate the content as copy into an Archival System (EAD):
            <ul>
            <li>Create a digital object for the track and its metadata in DSpace</li>
            <li>Link the digital object to the archival object in ArchivesSpace</li>
            <li>Respect archival standards</li>
        </ul>
            </li>
        </ul>
        <img class="substep graphic" src="images/archival_structure.png">
    </div>

    <div id="plan-goals" class="step" data-rel-x="0" data-rel-y="1000"
         data-goto-key-list="ArrowUp ArrowDown ArrowLeft ArrowRight"
         data-goto-next-list="icecream putting-together approach validation">
        <h1>Plan substeps and goals</h1>
        <ol>
            <li style="margin-bottom: -10px;">Login to DSpace via API </li>
            <pre><code>def login_to_dspace():
    response = requests.post(ds_endpoint, data=login_data)
    set_cookie = response.headers["Set-Cookie"].split(";")[0]
    session_id = set_cookie[set_cookie.find("=") + 1:]
    return session_id</code></pre>
            <li style="margin-bottom: -10px;">Upload the first track to DSpace</li>
            <pre><code># Uploads the track into the DSPACE object

def upload_track(ds_object_link, track_to_open, ds_object_tag):
    # track_list = create_track_list()
    # test_object = track_list[0]
    headers = {'Content-Type': 'application/json', 'Accept': 'application/json'}
    with open(track_to_open, 'rb') as content:
        requests.post(f"{ds_api_base_url}/{ds_object_link}/bitstreams?name={ds_object_tag}",
                      data=content,
                      headers=headers,
                      cookies={"JSESSIONID": login_to_dspace()})</code></pre>
            <li style="margin-bottom: -10px;">Link the track (digital object) to the right tape (archival object)</li>
            <pre><code># Use the ArchivesSpaceClient from Agentarchive to add a digital object (with the track) to the Archival Object

def link_dip_to_as(as_base_url, as_user, as_password, as_url_port, archival_obj_id, track_id, track_title,
                   link_to_bitstream):
    client = archivesspace.ArchivesSpaceClient(as_base_url, as_user, as_password, as_url_port)
    client.add_digital_object(
        parent_archival_object=f"/repositories/{as_archival_repo}/archival_objects/{archival_obj_id}",
        identifier=track_id, title=track_title, uri=link_to_bitstream, object_type="sound_recording")</code></pre>
        </ol>
    </div>


    <div id="putting-together" class="step" data-rel-x="0" data-rel-y="1000"
         data-goto-key-list="ArrowUp ArrowDown ArrowLeft ArrowRight"
         data-goto-next-list="plan-goals crisps bigger-dataset function-call">
        <h1>Putting things together</h1>

        <ul>
            <li>Getting the data of the archival objects</li>
            <li>iterating over the EAD structure to the component_id</li>
            <li>Check if the tape_id has a matching track</li>
            <li>Format the metadata for the creation of the digital object in DSpace</li>
            <li>Check if there is a corresponding file</li>
        </ul>
        <pre><code>
def main():
    as_login()
    as_ead_data = get_as_data(as_login())
    ds_tracks = {}
    for ds_track in create_track_list():  # for ds_track (which is a dict with info about the track) do:
        ds_tracks[ds_track['id']] = ds_track  # add to the dict ds_tracks a key which is the ds_track['id] and as the
        # value the respective ds_track
    fonds = as_ead_data['children']  # start iterating over the EAD-XML structure (now json) to get to the AO item
    for fond in fonds:
        subfonds = fond['children']
        for subfond in subfonds:
            items = subfond['children']
            for item in items:
                track_comp_id = item['component_id']  # save the id of the archival_object as track_comp_id
                if track_comp_id in ds_tracks:
                    matching_track = ds_tracks[track_comp_id]  # put the ds_track with the
                    # matching track_comp_id in matching_track
                    if len(matching_track['title']) == 0:  # if the file from the csv has no title use the one from AS
                        matching_track['title'] = item['title']
                    track_formatted = [format_metadata('dc.identifier', matching_track['id']),
                                       format_metadata('dc.title', matching_track['title'])]
                    if Path.exists(path_to_stored_file(matching_track)):  # check if there is a file behind the path
        </code></pre>
    </div>


    <!-- Crisps slides (3) -->
    <div id="starting" class="step" data-x="3500" data-y="2000"
         data-goto-key-list="ArrowUp ArrowDown ArrowLeft ArrowRight"
         data-goto-next-list="putting-together validation challenge approach">
        <h1>The starting point:</h1>
        <ul>
            <li>Postgres-DB dump contains:</li>
            <ul>
                <li>TrackId:
                    <ul>
                        <li class="marked">2909</li>
                    </ul>
                </li>
                <li>Filename:
                    <ul>
                        <li>Provider/TrackNumber_<span class="marked">TrackId:</span></li>
                        <li>SSOS/1234_<span class="marked">2909</span></li>
                    </ul>
                <li>Title of the track:
                    <ul>
                        <li>"Gràdh sìorraidh"</li>
                    </ul>
                </li>
            </ul>
            <br/>
            <li class="substep" style="margin-top: -30px;">Already in ArchivesSpace:</li>
            <ul class="substep">
                <li>Tape as archival object:</li>
                <ul>
                    <li>Metadata in EAD</li>
                    <li class="marked">ComponentId</li>
                </ul>
            </ul>
        </ul>
    </div>

    <div id="validation" class="step" data-rel-x="0" data-rel-y="1000"
         data-goto-key-list="ArrowUp ArrowDown ArrowLeft ArrowRight"
         data-goto-next-list="crisps function-call plan-goals bigger-dataset">
        <h1>Testing and Validating</h1>

        <ul>
            <li>Ensure that the file has been uploaded completely and undamaged</li>
            <li>Verify the archival structure and correct linking with archivists</li>
        </ul>
        <div class="substep">
        <h3 style="text-align: left">Find and fix bugs</h3>
        <ul>
            <li>pprint(response.status_code) pprint(response.content) pprint(response.json)</li>
            <li>Visit <a href="https://stackoverflow.com/">Stack Overflow</a></li>
            <li>View similar challenges & solutions: <a href="https://github.com/artefactual-labs/agentarchives/blob/master/agentarchives/archivesspace/client.py">github.com/artefactual-labs</a></li>
        </ul>
        </div>
        <div class="substep">
            <h3 style="text-align: left">Participate in meetings</h3>
            <ul>
                <li>Weekly catch up's with the project team to ensure an agile workflow</li>
            </ul>
        </div>
    </div>


    <div id="function-call" class="step" data-rel-x="0" data-rel-y="1000"
         data-goto-key-list="ArrowUp ArrowDown ArrowLeft ArrowRight"
         data-goto-next-list="validation applepie putting-together lesson-learned">
        <h1>Try calling those functions</h1>

        <ul>
            <li>Create the digital object in DSpace </li>
            <li>Upload the track</li>
            <li>Link the track to ArchivesSpace</li>
            <li>Logg Error's</li>
        </ul>
        <pre><code>
        try:
            # create the object in Dspace with the MD of the track, in the respective DS collection
            ds_object = create_dspace_record(track_formatted, ds_collection,
                                             login_to_dspace())
            #  upload the track in the created DS object and use the track_tag as the name for the track
            upload_track(ds_object['link'],
                         path_to_stored_file(matching_track),
                         matching_track['track_tag'])
            # create the link which has to be used in AS later and is created through the handle and tag
            link_to_bitstream = f"{ds_api_base_url}/bitstream/handle/{ds_object['handle']}/{matching_track['track_tag']}"
            # create a Digital object with the track and link it to the AO item in ArchivesSpace
            link_dip_to_as(as_base_url, as_user, as_password, as_url_port, item['id'],
                           matching_track['id'], matching_track['title'], link_to_bitstream)
            pprint(f" item id = {item['id']} and {matching_track['id']}")
        except:
            logging.warning("Unique Id already exists")
    else:
        pprint(f"{path_to_stored_file(matching_track)} is not in the test files")
        logging.warning(f"{path_to_stored_file(matching_track)} is not in the test files")
else:
    pprint(f"Track with id {track_comp_id} is not in the CSV")
    logging.warning(f"Track with id {track_comp_id} is not in the CSV")
        </code></pre>
    </div>


    <!-- Apple pie slides (3) -->
    <div id="approach" class="step" data-x="5000" data-y="2000"
         data-goto-key-list="ArrowUp ArrowDown ArrowLeft ArrowRight"
         data-goto-next-list="function-call bigger-dataset challenge plan-goals">
        <h1>My approach</h1>
        <ul>
            <li>Visualise migration flow and think in functions needed</li>
            <li>Read the RESTful API doc of <a href="https://archivesspace.github.io/archivesspace/api/#introduction">ArchivesSpace</a> & <a href="https://wiki.lyrasis.org/display/DSDOC5x/REST+API">DSpace</a></li>
            <li>Played around with the <a href="https://requests.readthedocs.io/en/master/">request lib in Python</a></li>
        </ul>
        <img class="whiteboard substep" src="images/migration_flow.png">
    </div>

    <div id="bigger-dataset" class="step" data-rel-x="0" data-rel-y="1000"
         data-goto-key-list="ArrowUp ArrowDown ArrowLeft ArrowRight"
         data-goto-next-list="applepie lesson-learned validation putting-together">
        <h1>Adapting to a bigger data set</h1>
        <ul>
            <li style="padding-top: 20px;">Creating a list of tracks (dict) with all information (Id, Path, Title, Tag)
            </li>
        </ul>

        <pre>
            <code>def get_catalogue_tracks():
    with open(path_to_csv,
              'r') as read_obj:
        tracks_as_dict = DictReader(read_obj)
        tracks_as_list = list(tracks_as_dict)
        return tracks_as_list


def create_track_list():
    track_list = get_catalogue_tracks()
    tracks_with_paths_list = []
    for track in track_list:
        data_folder = Path(path_to_files)
        if len(track['mp3']) > 0:  # check if there is a file specified to the entry in the csv
            if len(track['title']) < 0:  # check if the file has a title otherwise name it "untitled"
                track['title'] = "Untitled"
            path_to_track = data_folder / track['mp3']  # create the path to the file
            track.update({'track_path': path_to_track})  # update the track dict. with the path of the track
            track_tag = re.sub(r"/([0-9_]+)/\1\.", "/\\1.", track['mp3']).replace("/", "_")  # replace the "/" with "_"
            track.update({'track_tag': track_tag})  # update the track dict. with the tag of the track
            tracks_with_paths_list.append(track)  # add the track as dict. (with the keys: id, mp3, title, track_path,
            # track_tag) to the tracks_with_paths_list.
    return tracks_with_paths_list
            </code>
        </pre>
    </div>


    <div id="lesson-learned" class="step" data-rel-x="0" data-rel-y="1000"
         data-goto-key-list="ArrowUp ArrowDown ArrowLeft ArrowRight"
         data-goto-next-list="bigger-dataset future function-call future">
        <h1>Lessons learned</h1>
        <ul>
            <li>Communication is key!</li>
            <li>Testing, Testing, Testing</li>
            <li>Python and its libs are very convenient</li>
        </ul>
        <div class="substep">
        <h3>What could have been done better?</h3>
        <ul>
            <li>More Exceptions and improved error handling</li>
            <li>Cleaner Code</li>
            <li>Less self-made pressure</li>
        </ul>
        </div>
    </div>


    <div id="future" class="step" data-rel-x="1000" data-rel-y="1000">
        <h1>The future</h1>

        <ul>
            <li>Preserve the tapes with Archivematica as AIP</li>
            <li>Trigger the Script to upload and link the DIP</li>
        </ul>
        <img class="substep graphic" style="width: 73%; margin-left: 30%; margin-top: -30px;" src="images/OAIS.png">
    </div>

    <div id="bye" class="step" data-rel-x="1000" data-rel-y="1000">
        <h1>Thank you</h1>
        <img src="images/quote.png" style="width:100%">
    </div>

    <div id="overview" class="step" data-x="3000" data-y="2000" data-scale="9" style="pointer-events: none;">
    </div>
</div>

<div id="impress-toolbar"></div>

<div class="impress-progressbar"><div></div></div>
<div class="impress-progress"></div>

<div id="impress-help"></div>


<script type="text/javascript" src="js/impress.js"></script>
<script>impress().init();</script>

</body>
</html>
